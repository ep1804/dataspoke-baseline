openapi: "3.0.3"

info:
  title: DataSpoke API
  version: "0.1.0"
  description: |
    DataSpoke is a sidecar extension to DataHub that provides user-group-specific features
    for Data Engineers (DE), Data Analysts (DA), and Data Governance personnel (DG).

    ## Three-Tier URI Structure

    ```
    /api/v1/spoke/common/…     Cross-cutting features shared by DE, DA, and DG
    /api/v1/spoke/dg/…         Data Governance features (requires "dg" group claim)
    /api/v1/hub/…              DataHub pass-through (any valid group)
    /health, /ready            System probes (no auth, no /api/v1 prefix)
    ```

    The `/spoke/de/` and `/spoke/da/` tiers are reserved but have no routes currently defined.
    All shared dataset operations (ingestion, validation, generation, search) live under
    `/spoke/common/` so that any team that owns a dataset can access them regardless of
    group membership.

    ## Access Control

    JWT Bearer tokens are required for all routes except `/health`, `/ready`, and `/auth/`.
    The `groups` claim in the JWT payload is an array of user-group identifiers.
    The middleware enforces that the claim matches the URI tier.

    | URI tier | Required group |
    |----------|----------------|
    | `/spoke/common/…` | any valid group (`de`, `da`, or `dg`) |
    | `/spoke/dg/…` | `dg` |
    | `/hub/…` | any valid group |
    | `/auth/…`, `/health`, `/ready` | public |
    | `/admin/…` | `admin` |

    Users with `"admin"` in their `groups` claim bypass all group-tier restrictions.

    ## WebSocket Channels

    The following WebSocket endpoints exist alongside the REST API. They are not modelled
    as OpenAPI paths because the OpenAPI 3.0 specification does not support WebSocket.

    - `WS /api/v1/spoke/common/data/{dataset_urn}/stream/validation`
      Real-time validation progress stream. After the upgrade the client must send
      `{"type":"auth","token":"<access_token>"}` as the first message.

    - `WS /api/v1/spoke/dg/metric/stream`
      Real-time metric update stream. Same auth handshake applies.

    ## Pagination

    Collection responses wrap the resource array under a named key and include pagination
    metadata at the top level:

    ```json
    {
      "datasets": [...],
      "offset": 0,
      "limit": 20,
      "total_count": 143,
      "resp_time": "2026-02-27T10:00:00.000Z"
    }
    ```

    ## Standard Query Parameters

    | Parameter | Purpose |
    |-----------|---------|
    | `offset` | Pagination start; default `0` |
    | `limit` | Page size; default `20`, max `100` |
    | `sort` | Field + direction suffix, e.g. `occurred_at_desc` |
    | `from` | ISO 8601 start of time-range filter (inclusive) |
    | `to` | ISO 8601 end of time-range filter (inclusive) |
    | `q` | Natural language query (search endpoints only) |

servers:
  - url: http://localhost:8000/api/v1
    description: Local development
  - url: https://dataspoke.example.com/api/v1
    description: Production

# ---------------------------------------------------------------------------
# Tags
# ---------------------------------------------------------------------------
tags:
  - name: system
    description: Liveness and readiness probes. No authentication required.
  - name: auth
    description: Token issuance, refresh, and revocation.
  - name: common
    description: |
      Cross-cutting features available to all user groups: ontology, data resource,
      ingestion, validation, generation, and search.
  - name: dg
    description: Data Governance features — metrics dashboard and multi-perspective overview.
  - name: hub
    description: DataHub GMS pass-through.

# ---------------------------------------------------------------------------
# Paths
# ---------------------------------------------------------------------------
paths:

  # ==========================================================================
  # System
  # ==========================================================================

  /health:
    get:
      operationId: getHealth
      summary: Liveness check
      description: Returns 200 when the process is running. No authentication required.
      tags: [system]
      servers:
        - url: http://localhost:8000
          description: Local development (no /api/v1 prefix)
        - url: https://dataspoke.example.com
          description: Production (no /api/v1 prefix)
      responses:
        "200":
          description: Process is alive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /ready:
    get:
      operationId: getReady
      summary: Readiness check
      description: |
        Returns 200 when the service can handle traffic — i.e., DataHub GMS, PostgreSQL,
        and Redis are all reachable. No authentication required.
      tags: [system]
      servers:
        - url: http://localhost:8000
          description: Local development (no /api/v1 prefix)
        - url: https://dataspoke.example.com
          description: Production (no /api/v1 prefix)
      responses:
        "200":
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadyResponse"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"

  # ==========================================================================
  # Auth
  # ==========================================================================

  /auth/token:
    post:
      operationId: issueToken
      summary: Issue access and refresh tokens
      description: |
        Exchange email + password credentials for a short-lived access token (15 min)
        and a long-lived refresh token (7 days). The refresh token is returned as an
        HttpOnly cookie.
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TokenRequest"
      responses:
        "200":
          description: Tokens issued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
          headers:
            Set-Cookie:
              description: HttpOnly cookie containing the refresh token
              schema:
                type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/token/refresh:
    post:
      operationId: refreshToken
      summary: Refresh access token
      description: |
        Issue a new access token using the refresh token sent as an HttpOnly cookie.
      tags: [auth]
      responses:
        "200":
          description: New access token issued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/token/revoke:
    post:
      operationId: revokeToken
      summary: Revoke refresh token (logout)
      description: |
        Invalidate the refresh token. The client should discard the access token from memory.
      tags: [auth]
      responses:
        "204":
          description: Refresh token revoked
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ==========================================================================
  # Common — Ontology
  # ==========================================================================

  /spoke/common/ontology:
    get:
      operationId: listOntologyConcepts
      summary: List concept categories
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort"
      responses:
        "200":
          description: Paginated list of ontology concepts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OntologyConceptList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/ontology/{concept_id}:
    parameters:
      - $ref: "#/components/parameters/concept_id"
    get:
      operationId: getOntologyConcept
      summary: Get concept detail and relationships
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Concept detail with relationships
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OntologyConceptDetail"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/ontology/{concept_id}/attr:
    parameters:
      - $ref: "#/components/parameters/concept_id"
    get:
      operationId: getOntologyConceptAttr
      summary: Get concept attributes
      description: Returns attribute fields such as confidence score and parent concept.
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Concept attributes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OntologyConceptAttr"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/ontology/{concept_id}/event:
    parameters:
      - $ref: "#/components/parameters/concept_id"
    get:
      operationId: listOntologyConceptEvents
      summary: Get change history for a concept
      description: |
        Returns the immutable event log for this concept, ordered newest first by default.
        Supports `from`/`to` for time-range filtering.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated event log
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/ontology/{concept_id}/method/approve:
    parameters:
      - $ref: "#/components/parameters/concept_id"
    post:
      operationId: approveOntologyConcept
      summary: Approve a pending concept proposal
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConceptApproveRequest"
      responses:
        "200":
          description: Concept approved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MethodResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/ontology/{concept_id}/method/reject:
    parameters:
      - $ref: "#/components/parameters/concept_id"
    post:
      operationId: rejectOntologyConcept
      summary: Reject a pending concept proposal
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConceptRejectRequest"
      responses:
        "200":
          description: Concept rejected
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MethodResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ==========================================================================
  # Common — Data Resource
  # ==========================================================================

  /spoke/common/data/{dataset_urn}:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getDataset
      summary: Get dataset summary
      description: Returns identity, owner, and tags for the dataset.
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Dataset summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DatasetSummary"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "502":
          $ref: "#/components/responses/BadGateway"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/data/{dataset_urn}/attr:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getDatasetAttr
      summary: Get dataset attributes
      description: Returns schema summary, ownership, and tags.
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Dataset attributes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DatasetAttr"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "502":
          $ref: "#/components/responses/BadGateway"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/data/{dataset_urn}/event:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: listDatasetEvents
      summary: Get dataset-level event history
      description: |
        Returns all event types (ingestion, validation, generation) for this dataset,
        ordered newest first by default. Supports `from`/`to` for time-range filtering.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated event log
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # --------------------------------------------------------------------------
  # Data Resource — Ingestion
  # --------------------------------------------------------------------------

  /spoke/common/data/{dataset_urn}/attr/ingestion/conf:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getDatasetIngestionConf
      summary: Get ingestion configuration for dataset
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Ingestion configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestionConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
    put:
      operationId: putDatasetIngestionConf
      summary: Create or replace ingestion configuration
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestionConfWrite"
      responses:
        "200":
          description: Ingestion configuration replaced
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestionConf"
        "201":
          description: Ingestion configuration created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestionConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      operationId: patchDatasetIngestionConf
      summary: Partially update ingestion configuration
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestionConfPatch"
      responses:
        "200":
          description: Ingestion configuration updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestionConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"
    delete:
      operationId: deleteDatasetIngestionConf
      summary: Remove ingestion configuration
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "204":
          description: Ingestion configuration deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/data/{dataset_urn}/attr/ingestion/method/run:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    post:
      operationId: runDatasetIngestion
      summary: Trigger ingestion run
      description: |
        Enqueues an ingestion run via Temporal. Use `?dry_run=true` for no-write mode.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - name: config_id
          in: query
          description: ID of the ingestion configuration to use
          schema:
            type: string
        - name: dry_run
          in: query
          description: If true, perform a dry run without writing to DataHub
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: Ingestion run triggered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunTriggered"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/data/{dataset_urn}/attr/ingestion/event:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: listDatasetIngestionEvents
      summary: Get ingestion event reports
      description: |
        Returns success and failure notices for ingestion runs on this dataset,
        ordered newest first by default.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated ingestion event log
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # --------------------------------------------------------------------------
  # Data Resource — Validation
  # --------------------------------------------------------------------------

  /spoke/common/data/{dataset_urn}/attr/validation/conf:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getDatasetValidationConf
      summary: Get validation configuration for dataset
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Validation configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
    put:
      operationId: putDatasetValidationConf
      summary: Create or replace validation configuration
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ValidationConfWrite"
      responses:
        "200":
          description: Validation configuration replaced
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationConf"
        "201":
          description: Validation configuration created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      operationId: patchDatasetValidationConf
      summary: Partially update validation configuration
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ValidationConfPatch"
      responses:
        "200":
          description: Validation configuration updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"
    delete:
      operationId: deleteDatasetValidationConf
      summary: Remove validation configuration
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "204":
          description: Validation configuration deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/data/{dataset_urn}/attr/validation/result:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getDatasetValidationResult
      summary: Get validation results for dataset
      description: |
        Returns validation results as a timeseries. Use `?from=…&to=…` to narrow the
        time range (ISO 8601).
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated validation results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationResultList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/data/{dataset_urn}/attr/validation/method/run:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    post:
      operationId: runDatasetValidation
      summary: Trigger validation run
      description: |
        Enqueues a validation run via Temporal. Use `?dry_run=true` for no-write mode.
        Real-time progress is available via the WebSocket stream.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - name: config_id
          in: query
          description: ID of the validation configuration to use
          schema:
            type: string
        - name: dry_run
          in: query
          description: If true, compute results without persisting them
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: Validation run triggered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunTriggered"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/data/{dataset_urn}/attr/validation/event:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: listDatasetValidationEvents
      summary: Get validation event reports
      description: Returns success and failure notices for validation runs on this dataset.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated validation event log
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # --------------------------------------------------------------------------
  # Data Resource — Generation
  # --------------------------------------------------------------------------

  /spoke/common/data/{dataset_urn}/attr/gen/conf:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getDatasetGenConf
      summary: Get generation configuration for dataset
      description: Returns target fields, period, and active status.
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Generation configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
    put:
      operationId: putDatasetGenConf
      summary: Create or replace generation configuration
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GenConfWrite"
      responses:
        "200":
          description: Generation configuration replaced
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenConf"
        "201":
          description: Generation configuration created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      operationId: patchDatasetGenConf
      summary: Partially update generation configuration
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GenConfPatch"
      responses:
        "200":
          description: Generation configuration updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"
    delete:
      operationId: deleteDatasetGenConf
      summary: Remove generation configuration
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "204":
          description: Generation configuration deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/data/{dataset_urn}/attr/gen/result:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getDatasetGenResult
      summary: Get generation results for dataset
      description: |
        Returns historical generation results. Use `?latest=true` to return only the
        most recent result. Use `?from=…&to=…` for a time range.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - name: latest
          in: query
          description: If true, return only the most recent result
          schema:
            type: boolean
            default: false
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated generation results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenResultList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/data/{dataset_urn}/attr/gen/method/generate:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    post:
      operationId: runDatasetGenerate
      summary: Trigger metadata generation run
      description: Enqueues an LLM-powered metadata generation job via Temporal.
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Generation run triggered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunTriggered"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/data/{dataset_urn}/attr/gen/method/apply:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    post:
      operationId: applyDatasetGenResult
      summary: Apply approved generation results to DataHub
      description: |
        Writes approved LLM-generated metadata back to DataHub GMS aspects.
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GenApplyRequest"
      responses:
        "200":
          description: Generation results applied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MethodResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "502":
          $ref: "#/components/responses/BadGateway"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/data/{dataset_urn}/attr/gen/event:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: listDatasetGenEvents
      summary: Get generation event reports
      description: Returns success and failure notices for generation runs on this dataset.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated generation event log
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ==========================================================================
  # Common — Cross-dataset Ingestion
  # ==========================================================================

  /spoke/common/ingestion:
    get:
      operationId: listIngestionConfigs
      summary: List all ingestion configurations across datasets
      description: |
        Cross-dataset view of ingestion configurations. Each entry combines dataset
        identity with the ingestion config stored under
        `spoke/common/data/{dataset_urn}/attr/ingestion/`.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort"
        - name: status
          in: query
          description: Filter by ingestion config status
          schema:
            type: string
            enum: [active, inactive, error]
      responses:
        "200":
          description: Paginated list of ingestion configurations
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestionConfList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/ingestion/{dataset_urn}:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getIngestionConfig
      summary: Get ingestion configuration detail
      description: Returns dataset identity plus the full ingestion configuration body.
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Ingestion configuration detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestionConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/ingestion/{dataset_urn}/attr:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getIngestionConfigAttr
      summary: Get ingestion configuration attributes
      description: Returns schedule, deep_spec_enabled flag, status, and owner.
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Ingestion configuration attributes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestionConfAttr"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      operationId: patchIngestionConfigAttr
      summary: Update ingestion configuration attributes
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestionConfAttrPatch"
      responses:
        "200":
          description: Ingestion configuration attributes updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestionConfAttr"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/ingestion/{dataset_urn}/method/run:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    post:
      operationId: runIngestion
      summary: Trigger ingestion run
      description: Use `?dry_run=true` for no-write mode.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - name: dry_run
          in: query
          description: If true, perform a dry run without writing to DataHub
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: Ingestion run triggered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunTriggered"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/ingestion/{dataset_urn}/event:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: listIngestionEvents
      summary: Get ingestion event reports
      description: Returns success and failure notices for ingestion runs on this dataset.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated ingestion event log
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ==========================================================================
  # Common — Cross-dataset Validation
  # ==========================================================================

  /spoke/common/validation:
    get:
      operationId: listValidationConfigs
      summary: List all validation configurations across datasets
      description: |
        Cross-dataset view of validation configurations. Each entry combines dataset
        identity with the validation config stored under
        `spoke/common/data/{dataset_urn}/attr/validation/`.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort"
        - name: status
          in: query
          description: Filter by validation config status
          schema:
            type: string
            enum: [active, inactive, error]
      responses:
        "200":
          description: Paginated list of validation configurations
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationConfList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/validation/{dataset_urn}:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getValidationConfig
      summary: Get validation configuration detail
      description: Returns dataset identity plus the full validation configuration body.
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Validation configuration detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/validation/{dataset_urn}/attr:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getValidationConfigAttr
      summary: Get validation configuration attributes
      description: Returns rules, result spec, schedule, status, and owner.
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Validation configuration attributes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationConfAttr"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      operationId: patchValidationConfigAttr
      summary: Update validation configuration attributes
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ValidationConfAttrPatch"
      responses:
        "200":
          description: Validation configuration attributes updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationConfAttr"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/validation/{dataset_urn}/attr/result:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getValidationResult
      summary: Get validation results for dataset
      description: Returns validation results as a timeseries. Use `?from=…&to=…` to narrow the time range.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated validation results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationResultList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/validation/{dataset_urn}/method/run:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    post:
      operationId: runValidation
      summary: Trigger validation run
      description: Use `?dry_run=true` for no-write mode.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - name: dry_run
          in: query
          description: If true, compute results without persisting them
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: Validation run triggered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunTriggered"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/validation/{dataset_urn}/event:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: listValidationEvents
      summary: Get validation event reports
      description: Returns success and failure notices for validation runs on this dataset.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated validation event log
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ==========================================================================
  # Common — Cross-dataset Generation
  # ==========================================================================

  /spoke/common/gen:
    get:
      operationId: listGenConfigs
      summary: List all generation configurations across datasets
      description: |
        Cross-dataset view of generation configurations. Each entry combines dataset
        identity with the generation config stored under
        `spoke/common/data/{dataset_urn}/attr/gen/`.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort"
        - name: status
          in: query
          description: Filter by generation config status
          schema:
            type: string
            enum: [active, inactive, error]
      responses:
        "200":
          description: Paginated list of generation configurations
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenConfList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/gen/{dataset_urn}:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getGenConfig
      summary: Get generation configuration detail
      description: Returns dataset identity plus configuration and the latest result.
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Generation configuration detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/gen/{dataset_urn}/attr:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getGenConfigAttr
      summary: Get generation configuration attributes
      description: Returns target fields, period, status, and owner.
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Generation configuration attributes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenConfAttr"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      operationId: patchGenConfigAttr
      summary: Update generation configuration attributes
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GenConfAttrPatch"
      responses:
        "200":
          description: Generation configuration attributes updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenConfAttr"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/gen/{dataset_urn}/attr/result:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: getGenResult
      summary: Get generation results for dataset
      description: Returns historical generation results. Use `?from=…&to=…` to narrow the time range.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated generation results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenResultList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/gen/{dataset_urn}/method/generate:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    post:
      operationId: runGenerate
      summary: Trigger generation run
      description: Enqueues an LLM-powered metadata generation job via Temporal.
      tags: [common]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Generation run triggered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunTriggered"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/gen/{dataset_urn}/method/apply:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    post:
      operationId: applyGenResult
      summary: Apply approved generation results to DataHub
      description: Writes approved LLM-generated metadata back to DataHub GMS aspects.
      tags: [common]
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GenApplyRequest"
      responses:
        "200":
          description: Generation results applied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MethodResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "502":
          $ref: "#/components/responses/BadGateway"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/gen/{dataset_urn}/event:
    parameters:
      - $ref: "#/components/parameters/dataset_urn"
    get:
      operationId: listGenEvents
      summary: Get generation event reports
      description: Returns success and failure notices for generation runs on this dataset.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated generation event log
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ==========================================================================
  # Common — Search
  # ==========================================================================

  /spoke/common/search:
    get:
      operationId: search
      summary: Natural language search over dataset metadata
      description: |
        Vector similarity search over dataset metadata. Add `?sql_context=true` to include
        text-to-SQL optimized column detail, sample values, and inferred join paths in the
        response — this supersedes the former dedicated text-to-SQL and join-paths paths.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - name: q
          in: query
          required: true
          description: Natural language search query
          schema:
            type: string
        - name: sql_context
          in: query
          description: If true, include text-to-SQL context (column profiles, join paths, sample queries)
          schema:
            type: boolean
            default: false
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
      responses:
        "200":
          description: Ranked search results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchResultList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/common/search/method/reindex:
    post:
      operationId: reindexSearch
      summary: Trigger reindex for a dataset
      description: |
        Regenerates the vector embedding for the specified dataset and upserts it into
        Qdrant. Use `?dataset_urn=…` to target a single dataset.
      tags: [common]
      security:
        - BearerAuth: []
      parameters:
        - name: dataset_urn
          in: query
          required: true
          description: URN of the dataset to reindex
          schema:
            type: string
      responses:
        "200":
          description: Reindex job triggered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MethodResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ==========================================================================
  # DG — Metric
  # ==========================================================================

  /spoke/dg/metric:
    get:
      operationId: listMetrics
      summary: List all governance metrics
      description: Paginated list of metrics. Filterable by theme and status.
      tags: [dg]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort"
        - name: theme
          in: query
          description: Filter by metric theme
          schema:
            type: string
        - name: status
          in: query
          description: Filter by metric active status
          schema:
            type: string
            enum: [active, inactive]
      responses:
        "200":
          description: Paginated list of metrics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MetricList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/dg/metric/{metric_id}:
    parameters:
      - $ref: "#/components/parameters/metric_id"
    get:
      operationId: getMetric
      summary: Get metric summary
      description: Returns identity, theme, and active status.
      tags: [dg]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Metric summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MetricSummary"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/dg/metric/{metric_id}/attr:
    parameters:
      - $ref: "#/components/parameters/metric_id"
    get:
      operationId: getMetricAttr
      summary: Get metric attributes overview
      description: Returns theme, period, active status, and alarm enabled flag.
      tags: [dg]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Metric attributes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MetricAttr"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/dg/metric/{metric_id}/attr/conf:
    parameters:
      - $ref: "#/components/parameters/metric_id"
    get:
      operationId: getMetricConf
      summary: Get full metric definition
      description: Returns title, theme, measurement period, alarm setup, and active status.
      tags: [dg]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Full metric definition
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MetricConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
    put:
      operationId: putMetricConf
      summary: Create or replace metric definition
      tags: [dg]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MetricConfWrite"
      responses:
        "200":
          description: Metric definition replaced
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MetricConf"
        "201":
          description: Metric definition created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MetricConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      operationId: patchMetricConf
      summary: Update metric definition fields
      tags: [dg]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MetricConfPatch"
      responses:
        "200":
          description: Metric definition updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MetricConf"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"
    delete:
      operationId: deleteMetricConf
      summary: Remove metric definition
      tags: [dg]
      security:
        - BearerAuth: []
      responses:
        "204":
          description: Metric definition deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/dg/metric/{metric_id}/attr/result:
    parameters:
      - $ref: "#/components/parameters/metric_id"
    get:
      operationId: getMetricResult
      summary: Get measurement results for metric
      description: Returns numeric timeseries. Use `?from=…&to=…` to narrow the time range.
      tags: [dg]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated metric measurement results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MetricResultList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/dg/metric/{metric_id}/method/run:
    parameters:
      - $ref: "#/components/parameters/metric_id"
    post:
      operationId: runMetric
      summary: Trigger a metric measurement run
      tags: [dg]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Metric measurement run triggered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunTriggered"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/dg/metric/{metric_id}/method/activate:
    parameters:
      - $ref: "#/components/parameters/metric_id"
    post:
      operationId: activateMetric
      summary: Activate metric (enable scheduled measurement)
      tags: [dg]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Metric activated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MethodResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/dg/metric/{metric_id}/method/deactivate:
    parameters:
      - $ref: "#/components/parameters/metric_id"
    post:
      operationId: deactivateMetric
      summary: Deactivate metric
      tags: [dg]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Metric deactivated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MethodResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/dg/metric/{metric_id}/event:
    parameters:
      - $ref: "#/components/parameters/metric_id"
    get:
      operationId: listMetricEvents
      summary: Get metric run events and alarm notices
      tags: [dg]
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/offset"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/sort_occurred_at"
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
      responses:
        "200":
          description: Paginated metric event log
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ==========================================================================
  # DG — Overview
  # ==========================================================================

  /spoke/dg/overview:
    get:
      operationId: getDgOverview
      summary: Get multi-perspective overview snapshot
      description: |
        Returns graph-based topology views, medallion layer coverage maps, and similar
        structural views of the data estate.
      tags: [dg]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Overview snapshot
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DgOverview"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "502":
          $ref: "#/components/responses/BadGateway"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /spoke/dg/overview/attr:
    get:
      operationId: getDgOverviewAttr
      summary: Get visualization configuration
      description: Returns layout, coloring, and filter settings for the overview.
      tags: [dg]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Visualization configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DgOverviewAttr"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      operationId: patchDgOverviewAttr
      summary: Update visualization configuration
      tags: [dg]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DgOverviewAttrPatch"
      responses:
        "200":
          description: Visualization configuration updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DgOverviewAttr"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ==========================================================================
  # Hub pass-through
  # ==========================================================================

  /hub/graphql:
    post:
      operationId: hubGraphql
      summary: Proxy DataHub GraphQL queries
      description: |
        Forwards the request body to the DataHub GMS GraphQL endpoint after JWT validation.
        Returns the DataHub response as-is.
      tags: [hub]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GraphQLRequest"
      responses:
        "200":
          description: DataHub GraphQL response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GraphQLResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "502":
          $ref: "#/components/responses/BadGateway"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /hub/openapi/{path}:
    parameters:
      - name: path
        in: path
        required: true
        description: DataHub REST OpenAPI path to proxy
        schema:
          type: string
    get:
      operationId: hubOpenapiGet
      summary: Proxy DataHub REST OpenAPI (GET)
      tags: [hub]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: DataHub REST response
          content:
            application/json:
              schema:
                type: object
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "502":
          $ref: "#/components/responses/BadGateway"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"
    post:
      operationId: hubOpenapiPost
      summary: Proxy DataHub REST OpenAPI (POST)
      tags: [hub]
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: DataHub REST response
          content:
            application/json:
              schema:
                type: object
        "201":
          description: DataHub resource created
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "502":
          $ref: "#/components/responses/BadGateway"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"
    put:
      operationId: hubOpenapiPut
      summary: Proxy DataHub REST OpenAPI (PUT)
      tags: [hub]
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: DataHub REST response
          content:
            application/json:
              schema:
                type: object
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "502":
          $ref: "#/components/responses/BadGateway"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"
    patch:
      operationId: hubOpenapiPatch
      summary: Proxy DataHub REST OpenAPI (PATCH)
      tags: [hub]
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: DataHub REST response
          content:
            application/json:
              schema:
                type: object
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "502":
          $ref: "#/components/responses/BadGateway"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"
    delete:
      operationId: hubOpenapiDelete
      summary: Proxy DataHub REST OpenAPI (DELETE)
      tags: [hub]
      security:
        - BearerAuth: []
      responses:
        "204":
          description: DataHub resource deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "502":
          $ref: "#/components/responses/BadGateway"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"

# ---------------------------------------------------------------------------
# Components
# ---------------------------------------------------------------------------
components:

  # --------------------------------------------------------------------------
  # Security Schemes
  # --------------------------------------------------------------------------
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token. Obtain via `POST /auth/token`. Pass as
        `Authorization: Bearer <access_token>`.

  # --------------------------------------------------------------------------
  # Reusable Parameters
  # --------------------------------------------------------------------------
  parameters:
    dataset_urn:
      name: dataset_urn
      in: path
      required: true
      description: URL-encoded DataHub dataset URN (e.g. `urn%3Ali%3Adataset%3A%28urn%3Ali%3AdataPlatform%3Asnowflake%2Corders%2CPROD%29`)
      schema:
        type: string

    concept_id:
      name: concept_id
      in: path
      required: true
      description: Ontology concept identifier
      schema:
        type: string

    metric_id:
      name: metric_id
      in: path
      required: true
      description: Governance metric identifier
      schema:
        type: string

    offset:
      name: offset
      in: query
      description: Pagination start index (0-based)
      schema:
        type: integer
        default: 0
        minimum: 0

    limit:
      name: limit
      in: query
      description: Page size
      schema:
        type: integer
        default: 20
        minimum: 1
        maximum: 100

    sort:
      name: sort
      in: query
      description: |
        Sort field and direction as `{field}_{asc|desc}`, e.g. `created_at_desc`.
      schema:
        type: string

    sort_occurred_at:
      name: sort
      in: query
      description: |
        Sort field and direction. Default for event and result endpoints is `occurred_at_desc`.
      schema:
        type: string
        default: occurred_at_desc

    from:
      name: from
      in: query
      description: Start of time-range filter (ISO 8601 UTC), inclusive
      schema:
        type: string
        format: date-time
        example: "2026-01-01T00:00:00.000Z"

    to:
      name: to
      in: query
      description: End of time-range filter (ISO 8601 UTC), inclusive
      schema:
        type: string
        format: date-time
        example: "2026-02-27T23:59:59.999Z"

  # --------------------------------------------------------------------------
  # Reusable Responses
  # --------------------------------------------------------------------------
  responses:
    BadRequest:
      description: Malformed request, missing required fields, or invalid parameter values
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error_code: INVALID_PARAMETER
            message: "The 'limit' field must be an integer between 1 and 100."
            trace_id: "550e8400-e29b-41d4-a716-446655440000"

    Unauthorized:
      description: Missing, expired, or malformed access token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error_code: UNAUTHORIZED
            message: "Access token is missing or has expired."
            trace_id: "550e8400-e29b-41d4-a716-446655440000"

    Forbidden:
      description: Valid token but insufficient group claim for this route
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error_code: FORBIDDEN
            message: "Your account does not have access to this resource."
            trace_id: "550e8400-e29b-41d4-a716-446655440000"

    NotFound:
      description: Resource does not exist
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error_code: DATASET_NOT_FOUND
            message: "No dataset found for URN 'urn:li:dataset:unknown'."
            trace_id: "550e8400-e29b-41d4-a716-446655440000"

    Conflict:
      description: Duplicate resource or a run already in progress
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error_code: INGESTION_RUNNING
            message: "An ingestion run is already in progress for this dataset."
            trace_id: "550e8400-e29b-41d4-a716-446655440000"

    UnprocessableEntity:
      description: Pydantic validation failure (field type mismatch or constraint violation)
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error_code: MISSING_REQUIRED_FIELD
            message: "Required field 'source_type' was not provided."
            trace_id: "550e8400-e29b-41d4-a716-446655440000"

    TooManyRequests:
      description: Rate limit exceeded
      headers:
        Retry-After:
          description: Seconds to wait before retrying
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error_code: RATE_LIMIT_EXCEEDED
            message: "Too many requests. Please back off and retry."
            trace_id: "550e8400-e29b-41d4-a716-446655440000"

    BadGateway:
      description: DataHub GMS unreachable or returned an unexpected error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error_code: DATAHUB_UNAVAILABLE
            message: "DataHub GMS did not respond."
            trace_id: "550e8400-e29b-41d4-a716-446655440000"

    ServiceUnavailable:
      description: PostgreSQL, Redis, or Qdrant connection failed
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error_code: STORAGE_UNAVAILABLE
            message: "Unable to connect to the operational database."
            trace_id: "550e8400-e29b-41d4-a716-446655440000"

    InternalServerError:
      description: Unexpected server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  # --------------------------------------------------------------------------
  # Reusable Schemas
  # --------------------------------------------------------------------------
  schemas:

    # ------------------------------------------------------------------
    # Primitives and shared building blocks
    # ------------------------------------------------------------------

    ErrorResponse:
      type: object
      required: [error_code, message, trace_id]
      properties:
        error_code:
          type: string
          description: Machine-readable error code
          enum:
            - INVALID_PARAMETER
            - MISSING_REQUIRED_FIELD
            - UNAUTHORIZED
            - FORBIDDEN
            - DATASET_NOT_FOUND
            - CONCEPT_NOT_FOUND
            - CONFIG_NOT_FOUND
            - METRIC_NOT_FOUND
            - DUPLICATE_CONFIG
            - INGESTION_RUNNING
            - VALIDATION_RUNNING
            - GENERATION_RUNNING
            - DATAHUB_UNAVAILABLE
            - STORAGE_UNAVAILABLE
            - RATE_LIMIT_EXCEEDED
        message:
          type: string
          description: Human-readable description of the error
        trace_id:
          type: string
          format: uuid
          description: UUID v4 trace identifier; echoes X-Trace-Id request header

    PaginationMeta:
      type: object
      required: [offset, limit, total_count, resp_time]
      properties:
        offset:
          type: integer
          description: Start index used in this response
        limit:
          type: integer
          description: Page size used in this response
        total_count:
          type: integer
          description: Total number of items matching the query
        resp_time:
          type: string
          format: date-time
          description: Server time at response generation (ISO 8601 UTC)
          example: "2026-02-27T10:00:00.000Z"

    RespTimeMixin:
      type: object
      required: [resp_time]
      properties:
        resp_time:
          type: string
          format: date-time
          description: Server time at response generation (ISO 8601 UTC)
          example: "2026-02-27T10:00:00.000Z"

    # A uniform event item shared across all event endpoints.
    EventItem:
      type: object
      required: [event_id, event_type, status, occurred_at]
      properties:
        event_id:
          type: string
          format: uuid
        event_type:
          type: string
          description: "Category of the event, e.g. ingestion_run, validation_run, generation_run, concept_approved"
        status:
          type: string
          enum: [success, failure, warning, info]
        occurred_at:
          type: string
          format: date-time
          description: ISO 8601 UTC timestamp
        detail:
          type: object
          description: Event-type-specific payload
          additionalProperties: true

    EventList:
      allOf:
        - $ref: "#/components/schemas/PaginationMeta"
        - type: object
          required: [events]
          properties:
            events:
              type: array
              items:
                $ref: "#/components/schemas/EventItem"

    MethodResponse:
      allOf:
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [status]
          properties:
            status:
              type: string
              enum: [ok, pending]
            message:
              type: string

    RunTriggered:
      allOf:
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [run_id, status]
          properties:
            run_id:
              type: string
              format: uuid
              description: Temporal workflow run identifier
            status:
              type: string
              enum: [triggered, dry_run_completed]
            dry_run:
              type: boolean

    # ------------------------------------------------------------------
    # System
    # ------------------------------------------------------------------

    HealthResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [ok]

    ReadyResponse:
      type: object
      required: [status, checks]
      properties:
        status:
          type: string
          enum: [ok, degraded]
        checks:
          type: object
          properties:
            datahub:
              type: string
              enum: [ok, error]
            postgres:
              type: string
              enum: [ok, error]
            redis:
              type: string
              enum: [ok, error]

    # ------------------------------------------------------------------
    # Auth
    # ------------------------------------------------------------------

    TokenRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    TokenResponse:
      type: object
      required: [access_token, token_type, expires_in]
      properties:
        access_token:
          type: string
          description: Short-lived JWT (15 min)
        token_type:
          type: string
          enum: [bearer]
        expires_in:
          type: integer
          description: Seconds until the access token expires
          example: 900

    # ------------------------------------------------------------------
    # Ontology
    # ------------------------------------------------------------------

    OntologyConcept:
      type: object
      required: [concept_id, name, status, created_at]
      properties:
        concept_id:
          type: string
        name:
          type: string
        description:
          type: string
        parent_id:
          type: string
          nullable: true
        status:
          type: string
          enum: [active, pending, rejected]
        confidence_score:
          type: number
          format: float
          minimum: 0
          maximum: 1
        created_at:
          type: string
          format: date-time

    OntologyConceptList:
      allOf:
        - $ref: "#/components/schemas/PaginationMeta"
        - type: object
          required: [concepts]
          properties:
            concepts:
              type: array
              items:
                $ref: "#/components/schemas/OntologyConcept"

    OntologyConceptDetail:
      allOf:
        - $ref: "#/components/schemas/OntologyConcept"
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          properties:
            relationships:
              type: array
              items:
                type: object
                required: [related_concept_id, relationship_type]
                properties:
                  related_concept_id:
                    type: string
                  relationship_type:
                    type: string
                    enum: [parent, child, related, synonym]

    OntologyConceptAttr:
      allOf:
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [concept_id, confidence_score, status]
          properties:
            concept_id:
              type: string
            parent_id:
              type: string
              nullable: true
            confidence_score:
              type: number
              format: float
              minimum: 0
              maximum: 1
            status:
              type: string
              enum: [active, pending, rejected]
            updated_at:
              type: string
              format: date-time

    ConceptApproveRequest:
      type: object
      properties:
        comment:
          type: string

    ConceptRejectRequest:
      type: object
      properties:
        reason:
          type: string

    # ------------------------------------------------------------------
    # Data Resource
    # ------------------------------------------------------------------

    DatasetSummary:
      allOf:
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [urn, name]
          properties:
            urn:
              type: string
              description: DataHub dataset URN
            name:
              type: string
            platform:
              type: string
              description: Data platform name (e.g. snowflake, bigquery)
            description:
              type: string
              nullable: true
            owners:
              type: array
              items:
                type: string
            tags:
              type: array
              items:
                type: string
            quality_score:
              type: integer
              minimum: 0
              maximum: 100
              nullable: true

    DatasetAttr:
      allOf:
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [urn]
          properties:
            urn:
              type: string
            schema_summary:
              type: object
              properties:
                field_count:
                  type: integer
                fields:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                      type:
                        type: string
                      nullable:
                        type: boolean
            owners:
              type: array
              items:
                type: string
            tags:
              type: array
              items:
                type: string
            glossary_terms:
              type: array
              items:
                type: string
            last_modified:
              type: string
              format: date-time
              nullable: true

    # ------------------------------------------------------------------
    # Ingestion Configuration
    # ------------------------------------------------------------------

    IngestionConfBase:
      type: object
      required: [dataset_urn, source_type]
      properties:
        dataset_urn:
          type: string
        source_type:
          type: string
          description: "Ingestion source type, e.g. snowflake, bigquery, confluence"
        schedule:
          type: string
          description: Cron expression for scheduled ingestion
          nullable: true
        deep_spec_enabled:
          type: boolean
          default: false
          description: Enable deep technical spec extraction
        config_body:
          type: object
          description: Source-specific configuration (arbitrary JSON)
          additionalProperties: true
        owner:
          type: string
          nullable: true

    IngestionConf:
      allOf:
        - $ref: "#/components/schemas/IngestionConfBase"
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [config_id, status, created_at]
          properties:
            config_id:
              type: string
              format: uuid
            status:
              type: string
              enum: [active, inactive, error]
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time

    IngestionConfWrite:
      allOf:
        - $ref: "#/components/schemas/IngestionConfBase"

    IngestionConfPatch:
      type: object
      properties:
        schedule:
          type: string
          nullable: true
        deep_spec_enabled:
          type: boolean
        config_body:
          type: object
          additionalProperties: true
        owner:
          type: string
          nullable: true

    IngestionConfList:
      allOf:
        - $ref: "#/components/schemas/PaginationMeta"
        - type: object
          required: [ingestion_configs]
          properties:
            ingestion_configs:
              type: array
              items:
                $ref: "#/components/schemas/IngestionConf"

    IngestionConfAttr:
      allOf:
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [config_id, status]
          properties:
            config_id:
              type: string
              format: uuid
            schedule:
              type: string
              nullable: true
            deep_spec_enabled:
              type: boolean
            status:
              type: string
              enum: [active, inactive, error]
            owner:
              type: string
              nullable: true
            updated_at:
              type: string
              format: date-time

    IngestionConfAttrPatch:
      type: object
      properties:
        schedule:
          type: string
          nullable: true
        deep_spec_enabled:
          type: boolean
        owner:
          type: string
          nullable: true

    # ------------------------------------------------------------------
    # Validation Configuration
    # ------------------------------------------------------------------

    ValidationRule:
      type: object
      required: [rule_id, rule_type]
      properties:
        rule_id:
          type: string
        rule_type:
          type: string
          description: "Rule type, e.g. not_null, uniqueness, freshness, custom_sql"
        field:
          type: string
          nullable: true
        threshold:
          type: number
          format: float
          nullable: true
        params:
          type: object
          additionalProperties: true

    ValidationConfBase:
      type: object
      required: [dataset_urn]
      properties:
        dataset_urn:
          type: string
        rules:
          type: array
          items:
            $ref: "#/components/schemas/ValidationRule"
        schedule:
          type: string
          description: Cron expression for scheduled validation
          nullable: true
        result_retention_days:
          type: integer
          default: 90
        owner:
          type: string
          nullable: true

    ValidationConf:
      allOf:
        - $ref: "#/components/schemas/ValidationConfBase"
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [config_id, status, created_at]
          properties:
            config_id:
              type: string
              format: uuid
            status:
              type: string
              enum: [active, inactive, error]
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time

    ValidationConfWrite:
      allOf:
        - $ref: "#/components/schemas/ValidationConfBase"

    ValidationConfPatch:
      type: object
      properties:
        rules:
          type: array
          items:
            $ref: "#/components/schemas/ValidationRule"
        schedule:
          type: string
          nullable: true
        result_retention_days:
          type: integer
        owner:
          type: string
          nullable: true

    ValidationConfList:
      allOf:
        - $ref: "#/components/schemas/PaginationMeta"
        - type: object
          required: [validation_configs]
          properties:
            validation_configs:
              type: array
              items:
                $ref: "#/components/schemas/ValidationConf"

    ValidationConfAttr:
      allOf:
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [config_id, status]
          properties:
            config_id:
              type: string
              format: uuid
            rule_count:
              type: integer
            schedule:
              type: string
              nullable: true
            result_retention_days:
              type: integer
            status:
              type: string
              enum: [active, inactive, error]
            owner:
              type: string
              nullable: true

    ValidationConfAttrPatch:
      type: object
      properties:
        schedule:
          type: string
          nullable: true
        result_retention_days:
          type: integer
        owner:
          type: string
          nullable: true

    ValidationResultItem:
      type: object
      required: [result_id, dataset_urn, quality_score, occurred_at]
      properties:
        result_id:
          type: string
          format: uuid
        dataset_urn:
          type: string
        quality_score:
          type: integer
          minimum: 0
          maximum: 100
        issues:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
              severity:
                type: string
                enum: [critical, warning, info]
              detail:
                type: string
              field:
                type: string
                nullable: true
        recommendations:
          type: array
          items:
            type: string
        occurred_at:
          type: string
          format: date-time
        run_id:
          type: string
          format: uuid

    ValidationResultList:
      allOf:
        - $ref: "#/components/schemas/PaginationMeta"
        - type: object
          required: [validation_results]
          properties:
            validation_results:
              type: array
              items:
                $ref: "#/components/schemas/ValidationResultItem"

    # ------------------------------------------------------------------
    # Generation Configuration
    # ------------------------------------------------------------------

    GenTargetField:
      type: object
      required: [field_name]
      properties:
        field_name:
          type: string
          description: "Target metadata field, e.g. description, glossary_terms, tags"
        overwrite_existing:
          type: boolean
          default: false

    GenConfBase:
      type: object
      required: [dataset_urn]
      properties:
        dataset_urn:
          type: string
        target_fields:
          type: array
          items:
            $ref: "#/components/schemas/GenTargetField"
        period:
          type: string
          description: Cron expression for scheduled generation
          nullable: true
        owner:
          type: string
          nullable: true

    GenConf:
      allOf:
        - $ref: "#/components/schemas/GenConfBase"
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [config_id, status, created_at]
          properties:
            config_id:
              type: string
              format: uuid
            status:
              type: string
              enum: [active, inactive, error]
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time
            latest_result:
              $ref: "#/components/schemas/GenResultItem"
              nullable: true

    GenConfWrite:
      allOf:
        - $ref: "#/components/schemas/GenConfBase"

    GenConfPatch:
      type: object
      properties:
        target_fields:
          type: array
          items:
            $ref: "#/components/schemas/GenTargetField"
        period:
          type: string
          nullable: true
        owner:
          type: string
          nullable: true

    GenConfList:
      allOf:
        - $ref: "#/components/schemas/PaginationMeta"
        - type: object
          required: [gen_configs]
          properties:
            gen_configs:
              type: array
              items:
                $ref: "#/components/schemas/GenConf"

    GenConfAttr:
      allOf:
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [config_id, status]
          properties:
            config_id:
              type: string
              format: uuid
            target_fields:
              type: array
              items:
                $ref: "#/components/schemas/GenTargetField"
            period:
              type: string
              nullable: true
            status:
              type: string
              enum: [active, inactive, error]
            owner:
              type: string
              nullable: true

    GenConfAttrPatch:
      type: object
      properties:
        target_fields:
          type: array
          items:
            $ref: "#/components/schemas/GenTargetField"
        period:
          type: string
          nullable: true
        owner:
          type: string
          nullable: true

    GenResultItem:
      type: object
      required: [result_id, dataset_urn, status, occurred_at]
      properties:
        result_id:
          type: string
          format: uuid
        dataset_urn:
          type: string
        status:
          type: string
          enum: [pending_review, approved, rejected, applied]
        generated_fields:
          type: object
          description: Map of field name to generated value
          additionalProperties:
            type: string
        occurred_at:
          type: string
          format: date-time
        run_id:
          type: string
          format: uuid

    GenResultList:
      allOf:
        - $ref: "#/components/schemas/PaginationMeta"
        - type: object
          required: [gen_results]
          properties:
            gen_results:
              type: array
              items:
                $ref: "#/components/schemas/GenResultItem"

    GenApplyRequest:
      type: object
      properties:
        result_id:
          type: string
          format: uuid
          description: Specific result to apply. If omitted, applies the latest approved result.

    # ------------------------------------------------------------------
    # Search
    # ------------------------------------------------------------------

    SearchResultItem:
      type: object
      required: [urn, name, score]
      properties:
        urn:
          type: string
        name:
          type: string
        platform:
          type: string
        description:
          type: string
          nullable: true
        tags:
          type: array
          items:
            type: string
        owners:
          type: array
          items:
            type: string
        quality_score:
          type: integer
          nullable: true
        score:
          type: number
          format: float
          description: Semantic similarity score (0.0–1.0)
        sql_context:
          description: Present only when `?sql_context=true`
          nullable: true
          type: object
          properties:
            columns:
              type: array
              items:
                type: object
                properties:
                  name:
                    type: string
                  type:
                    type: string
                  sample_values:
                    type: array
                    items:
                      type: string
            join_paths:
              type: array
              items:
                type: object
                properties:
                  target_urn:
                    type: string
                  join_keys:
                    type: array
                    items:
                      type: string
            sample_query:
              type: string
              nullable: true

    SearchResultList:
      allOf:
        - $ref: "#/components/schemas/PaginationMeta"
        - type: object
          required: [datasets]
          properties:
            datasets:
              type: array
              items:
                $ref: "#/components/schemas/SearchResultItem"

    # ------------------------------------------------------------------
    # DG — Metric
    # ------------------------------------------------------------------

    MetricSummary:
      allOf:
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [metric_id, title, theme, active]
          properties:
            metric_id:
              type: string
            title:
              type: string
            theme:
              type: string
              description: "Metric theme, e.g. documentation, ownership, freshness, errors"
            active:
              type: boolean
            created_at:
              type: string
              format: date-time

    MetricList:
      allOf:
        - $ref: "#/components/schemas/PaginationMeta"
        - type: object
          required: [metrics]
          properties:
            metrics:
              type: array
              items:
                $ref: "#/components/schemas/MetricSummary"

    MetricAttr:
      allOf:
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [metric_id, theme, active]
          properties:
            metric_id:
              type: string
            theme:
              type: string
            period:
              type: string
              description: Cron expression for scheduled measurement
              nullable: true
            active:
              type: boolean
            alarm_enabled:
              type: boolean

    MetricConfBase:
      type: object
      required: [title, theme]
      properties:
        title:
          type: string
        theme:
          type: string
        description:
          type: string
          nullable: true
        period:
          type: string
          description: Cron expression for scheduled measurement
          nullable: true
        alarm_enabled:
          type: boolean
          default: false
        alarm_threshold:
          type: number
          format: float
          nullable: true
          description: Trigger alarm when measured value exceeds this threshold
        filters:
          type: object
          description: Optional filter criteria (e.g. medallion layer, domain)
          additionalProperties: true

    MetricConf:
      allOf:
        - $ref: "#/components/schemas/MetricConfBase"
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [metric_id, active, created_at]
          properties:
            metric_id:
              type: string
            active:
              type: boolean
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time

    MetricConfWrite:
      allOf:
        - $ref: "#/components/schemas/MetricConfBase"

    MetricConfPatch:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
          nullable: true
        period:
          type: string
          nullable: true
        alarm_enabled:
          type: boolean
        alarm_threshold:
          type: number
          format: float
          nullable: true
        filters:
          type: object
          additionalProperties: true

    MetricResultItem:
      type: object
      required: [result_id, metric_id, value, occurred_at]
      properties:
        result_id:
          type: string
          format: uuid
        metric_id:
          type: string
        value:
          type: number
          format: float
          description: Numeric measurement value
        alarm:
          type: boolean
          description: True if the value triggered the alarm threshold
        occurred_at:
          type: string
          format: date-time
        run_id:
          type: string
          format: uuid

    MetricResultList:
      allOf:
        - $ref: "#/components/schemas/PaginationMeta"
        - type: object
          required: [metric_results]
          properties:
            metric_results:
              type: array
              items:
                $ref: "#/components/schemas/MetricResultItem"

    # ------------------------------------------------------------------
    # DG — Overview
    # ------------------------------------------------------------------

    DgOverviewNode:
      type: object
      required: [urn, name, medallion_layer]
      properties:
        urn:
          type: string
        name:
          type: string
        medallion_layer:
          type: string
          enum: [bronze, silver, gold, unknown]
        quality_score:
          type: integer
          nullable: true
        domain:
          type: string
          nullable: true

    DgOverviewEdge:
      type: object
      required: [source_urn, target_urn, relationship]
      properties:
        source_urn:
          type: string
        target_urn:
          type: string
        relationship:
          type: string
          enum: [upstream, downstream, related]

    DgOverview:
      allOf:
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [nodes, edges, medallion_coverage]
          properties:
            nodes:
              type: array
              items:
                $ref: "#/components/schemas/DgOverviewNode"
            edges:
              type: array
              items:
                $ref: "#/components/schemas/DgOverviewEdge"
            medallion_coverage:
              type: object
              description: Dataset count per medallion layer
              properties:
                bronze:
                  type: integer
                silver:
                  type: integer
                gold:
                  type: integer
                unknown:
                  type: integer
            blind_spots:
              type: array
              items:
                type: string
              description: Urns of datasets with no ownership or description

    DgOverviewAttr:
      allOf:
        - $ref: "#/components/schemas/RespTimeMixin"
        - type: object
          required: [layout, coloring]
          properties:
            layout:
              type: string
              enum: [force_directed, hierarchical, radial]
              default: force_directed
            coloring:
              type: string
              enum: [quality_score, medallion_layer, domain]
              default: quality_score
            filters:
              type: object
              description: Active filter selections (e.g. domain, medallion layer)
              additionalProperties: true

    DgOverviewAttrPatch:
      type: object
      properties:
        layout:
          type: string
          enum: [force_directed, hierarchical, radial]
        coloring:
          type: string
          enum: [quality_score, medallion_layer, domain]
        filters:
          type: object
          additionalProperties: true

    # ------------------------------------------------------------------
    # Hub pass-through
    # ------------------------------------------------------------------

    GraphQLRequest:
      type: object
      required: [query]
      properties:
        query:
          type: string
          description: GraphQL query string
        variables:
          type: object
          additionalProperties: true
          nullable: true
        operation_name:
          type: string
          nullable: true

    GraphQLResponse:
      type: object
      properties:
        data:
          type: object
          additionalProperties: true
          nullable: true
        errors:
          type: array
          nullable: true
          items:
            type: object
            properties:
              message:
                type: string
              locations:
                type: array
                items:
                  type: object
              path:
                type: array
                items: {}
              extensions:
                type: object
                additionalProperties: true
